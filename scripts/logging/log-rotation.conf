# ADHD 生產力系統 - 日誌輪轉配置
# 用於 logrotate 的配置檔案

# ===========================================
# 應用程式日誌輪轉
# ===========================================
/app/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 app app
    postrotate
        # 通知應用程式重新開啟日誌檔案
        docker kill -s HUP adhd-backend-prod 2>/dev/null || true
    endscript
}

# ===========================================
# Nginx 日誌輪轉
# ===========================================
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0644 nginx nginx
    sharedscripts
    postrotate
        # 重載 Nginx 以重新開啟日誌檔案
        docker kill -s USR1 adhd-nginx-prod 2>/dev/null || true
    endscript
}

# ===========================================
# PostgreSQL 日誌輪轉
# ===========================================
/var/lib/postgresql/data/log/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0600 postgres postgres
    postrotate
        # PostgreSQL 會自動處理日誌輪轉
        echo "PostgreSQL log rotated on $(date)" >> /var/log/postgresql-rotation.log
    endscript
}

# ===========================================
# 安全審計日誌輪轉
# ===========================================
/app/logs/security/*.log {
    daily
    missingok
    rotate 365
    compress
    delaycompress
    notifempty
    create 0600 app app
    # 安全日誌保留更長時間 (1年)
    postrotate
        # 記錄安全日誌輪轉事件
        echo "$(date): Security logs rotated" >> /var/log/audit-rotation.log
    endscript
}

# ===========================================
# 效能監控日誌輪轉
# ===========================================
/app/logs/performance/*.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 0644 app app
}

# ===========================================
# 備份日誌輪轉
# ===========================================
/logs/backup*.log {
    weekly
    missingok
    rotate 24
    compress
    delaycompress
    notifempty
    create 0644 backup backup
}

# ===========================================
# 系統日誌輪轉
# ===========================================
/var/log/adhd-system/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 root root
}