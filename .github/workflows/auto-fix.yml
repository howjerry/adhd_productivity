name: Auto Fix

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: Auto Fix Issues
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json
          backend/package-lock.json

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # Frontend è‡ªå‹•ä¿®å¾©
    - name: Fix Frontend Issues
      working-directory: ./frontend
      run: |
        echo "=== Installing dependencies ==="
        npm ci

        echo "=== Running ESLint auto-fix ==="
        npm run lint:fix || true

        echo "=== Running Prettier format ==="
        npm run format || true

        echo "=== Organizing imports ==="
        npx organize-imports-cli 'src/**/*.{ts,tsx}' --write || true

        echo "=== Running npm audit fix (only production) ==="
        npm audit fix --only=prod || true

    # Backend Node.js è‡ªå‹•ä¿®å¾©
    - name: Fix Backend Node.js Issues
      working-directory: ./backend
      run: |
        if [ -f package.json ]; then
          echo "=== Installing dependencies ==="
          npm ci

          echo "=== Running ESLint auto-fix ==="
          npm run lint:fix || true

          echo "=== Running Prettier format ==="
          npm run format || true

          echo "=== Running npm audit fix (only production) ==="
          npm audit fix --only=prod || true
        fi

    # Backend .NET è‡ªå‹•ä¿®å¾©
    - name: Fix Backend .NET Issues
      working-directory: ./backend
      run: |
        echo "=== Running dotnet format ==="
        dotnet format --verbosity diagnostic || true

        echo "=== Running dotnet restore ==="
        dotnet restore || true

    # æ ¹ç›®éŒ„è‡ªå‹•ä¿®å¾©
    - name: Fix Root Issues
      run: |
        if [ -f package.json ]; then
          echo "=== Running npm audit fix (only production) ==="
          npm audit fix --only=prod || true
        fi

    # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
    - name: Check for changes
      id: changes
      run: |
        if [[ -n $(git status -s) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          git diff --name-only
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes to commit"
        fi

    # æäº¤è®Šæ›´
    - name: Commit changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # åˆ†éšæ®µæäº¤ä¸åŒé¡å‹çš„ä¿®å¾©
        
        # 1. ç¨‹å¼ç¢¼æ ¼å¼åŒ–
        git add "*.ts" "*.tsx" "*.js" "*.jsx" "*.cs" "*.json" || true
        if [[ -n $(git diff --cached --name-only) ]]; then
          git commit -m "ğŸ¨ Auto-fix: Format code with ESLint, Prettier and dotnet format"
        fi
        
        # 2. package-lock.json æ›´æ–°
        git add "**/package-lock.json" || true
        if [[ -n $(git diff --cached --name-only) ]]; then
          git commit -m "ğŸ”’ Auto-fix: Update package-lock.json (security fixes)"
        fi
        
        # 3. å…¶ä»–æª”æ¡ˆ
        git add -A || true
        if [[ -n $(git diff --cached --name-only) ]]; then
          git commit -m "ğŸ”§ Auto-fix: Apply other automatic fixes"
        fi
        
        git push

    # æ·»åŠ è©•è«–
    - name: Add PR comment
      if: steps.changes.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `### ğŸ¤– è‡ªå‹•ä¿®å¾©å·²å¥—ç”¨

          ä»¥ä¸‹å•é¡Œå·²è‡ªå‹•ä¿®å¾©ï¼š
          - âœ… ESLint è¦å‰‡é•å
          - âœ… Prettier æ ¼å¼åŒ–
          - âœ… Import çµ„ç¹”å’Œæ’åº
          - âœ… npm å®‰å…¨æ€§æ¼æ´ï¼ˆåƒ…ç”Ÿç”¢ä¾è³´ï¼‰
          - âœ… .NET ç¨‹å¼ç¢¼æ ¼å¼åŒ–

          è«‹åŸ·è¡Œ \`git pull\` ä»¥å–å¾—æœ€æ–°è®Šæ›´ã€‚`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    # å¦‚æœæ²’æœ‰è®Šæ›´ï¼Œä¹Ÿæ·»åŠ è©•è«–
    - name: Add no changes comment
      if: steps.changes.outputs.has_changes == 'false'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `### âœ¨ ç¨‹å¼ç¢¼å“è³ªè‰¯å¥½

          è‡ªå‹•ä¿®å¾©æƒæå®Œæˆï¼Œæ²’æœ‰ç™¼ç¾éœ€è¦ä¿®å¾©çš„å•é¡Œï¼`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # åŸ·è¡Œä¿®å¾©å¾Œçš„é©—è­‰
  verify-fixes:
    name: Verify Fixes
    needs: auto-fix
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout updated code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json
          backend/package-lock.json

    - name: Verify Frontend
      working-directory: ./frontend
      run: |
        echo "=== Installing dependencies ==="
        npm ci
        
        echo "=== Running lint check ==="
        npm run lint || echo "Some lint issues remain"
        
        echo "=== Running type check ==="
        npm run typecheck || echo "Some type issues remain"

    - name: Verify Backend
      working-directory: ./backend
      run: |
        if [ -f package.json ]; then
          echo "=== Installing dependencies ==="
          npm ci
          
          echo "=== Running lint check ==="
          npm run lint || echo "Some lint issues remain"
        fi